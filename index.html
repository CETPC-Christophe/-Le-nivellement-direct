<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MODULE 4</title>
<style>
:root { --orange:#ff6600; --noir:#222; --gris:#f3f3f3; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--gris); color: var(--noir); margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:16px; }
.banner { background:var(--noir); color:#fff; padding:10px; border-radius:10px; text-align:center; font-weight:700; width:100%; max-width:820px; margin-bottom:15px; }
h1 { color:var(--orange); text-align:center; margin:8px 0; }
.subtitle { color:#555; text-align:center; margin-bottom:18px; }
.question { background:#fff; padding:20px; margin:10px auto; border-left:8px solid var(--orange); border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.08); width:100%; max-width:820px; text-align:center; }
.question p { font-weight:600; }
.answers input[type="number"] { width:90%; max-width:420px; padding:10px; font-size:1.1rem; border-radius:6px; border:1px solid #ccc; margin-top:10px; }
button { background:var(--orange); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-size:1rem; cursor:pointer; margin-top:15px; }
button[disabled] { opacity:0.5; cursor:not-allowed; }
button:hover:not([disabled]) { background:#e65c00; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
thead { background:#f0f0f0; }
@media (max-width:600px){ .answers input{ width:100%; } }
</style>
</head>
<body>

<div class="banner">üìö TOPOGRAPHIE - MODULE 4 üìö</div>
<h1 id="pageTitle">Le nivellement direct</h1>
<p class="subtitle" id="quizSubtitle"></p>

<div id="intro" class="intro">
  <div id="testTypeSelection" class="question">
    <p style="font-weight:600; font-size:1.1rem;">S√©lectionnez le type de test</p>
    <div style="margin-top:20px;">
      <button id="trainingBtn" style="background:#4CAF50; margin:10px; padding:15px 25px; font-size:1.05rem; width:200px;">üìö Exercice 2<br><span style="font-size:0.85rem;">(10 questions)</span></button>
      
      <!-- Libell√© mis √† jour: "Entra√Ænement" -->
      <script>
        // Met √† jour le texte du bouton pour correspondre √† la demande
        (function(){
          var btn = document.getElementById('trainingBtn');
          if(btn){
            btn.innerHTML = "üìö Entra√Ænement<br><span style=\"font-size:0.85rem;\">(10 questions)</span>";
          }
        })();
      </script>
      <button id="evaluationBtn" style="background:#ff6600; margin:10px; padding:15px 25px; font-size:1.05rem; width:200px;">üéØ √âvaluation<br><span style="font-size:0.85rem;">(10 questions)</span></button>
    </div>
  </div>
  
  <div id="nameSelection" class="question" style="display:none;">
    <p id="welcomeTitle"></p>
    <p id="welcomeText"></p>
    <input id="candidateName" type="text" placeholder="Nom de l'√©l√®ve">
    <div style="margin-top:12px;">
      <button id="startBtn" disabled>‚û°Ô∏è Suivant</button>
    </div>
  </div>
</div>

<div id="quiz" style="display:none; width:100%; max-width:820px;"></div>
<div class="control-container" style="text-align:center;">
  <button id="restartBtn" style="display:none;">Retour accueil</button>
</div>

<script>
const i18n = {
  welcome: "Bienvenue",
  enterName: "Merci d'indiquer votre nom avant de commencer :",
  nextBtn: "‚û°Ô∏è Suivant",
  finishBtn: "üèÅ Terminer",
  questions: "R√©pondez √† {count} questions",
  candidate: "Candidat : ",
  date: "Date : ",
  result: "R√©sultat : ",
  question: "‚öôÔ∏è Question {num} / {total} : {text}"
};

const AUTHORIZED_CANDIDATES = {
  "Professeur": ["MARINO","CHARDON","CHIOTTI","MATHIEU","MAUSSION"],
  "1 cetpc": ["FONELLERAS","BONTEMPS","BRIATORE","BUCCIO","DIONISI","ERETEO","GARNERO","GRISONI","GUENEAU","HADANGUE","LACROIX","LEJEUNE","MAAZAOUI","MARTINEAU","MONELLO","PI-BUTHION","QUILICO","REMY","SANTIAGO","SCIARAFFA","THEVENET","TRUFFE","VILLEROY"],
  "2 cetpc": ["ALBERT","AUDISIO","BABA","BERTOLOTTO","BOUCHEE","BOUFFART","BOURGUIGNON","BOUSQUET","CAPPADORO","COLPAERT","CULMINE","DOYEN","GAALOUL","GEORGE","GUEURUNURIAN","MONTEIRO","PAGE","PALAGONIA","PELLET","PONZO","PRUVOST","RICHARD","TETI"]
};

const allThemes = [
  { name:"Calculer l'altitude du point 1", count:1, questions:Array(20).fill({ text:"Calculez l'altitude du point 1." }) },
  { name:"Calculer l'altitude du point 2", count:1, questions:Array(20).fill({ text:"Calculez l'altitude du point 2." }) }
];

let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = "";
let score = 0;
let quizName = "MODULE 4";
let testType = "";
let questionCount = 10;
const DOM = {
  intro: document.getElementById("intro"),
  quiz: document.getElementById("quiz"),
  startBtn: document.getElementById("startBtn"),
  restartBtn: document.getElementById("restartBtn"),
  candidateName: document.getElementById("candidateName"),
  quizSubtitle: document.getElementById("quizSubtitle"),
  pageTitle: document.getElementById("pageTitle"),
  testTypeSelection: document.getElementById("testTypeSelection"),
  nameSelection: document.getElementById("nameSelection"),
  trainingBtn: document.getElementById("trainingBtn"),
  evaluationBtn: document.getElementById("evaluationBtn")
};

function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }

function getRandomQuestionsIntercalated() {
  const questionsPerTheme = questionCount / allThemes.length;
  const themeQuestions = allThemes.map(theme => {
    const shuffled = shuffle([...theme.questions]);
    return shuffled.slice(0, questionsPerTheme).map(q => ({ ...q, theme: theme.name }));
  });

  const finalList = [];
  let remaining = true;
  let index = 0;

  while (remaining) {
    remaining = false;
    for (const questions of themeQuestions) {
      if (index < questions.length) {
        finalList.push(questions[index]);
        remaining = true;
      }
    }
    index++;
  }
  return finalList;
}

function renderQuestion(){
  const q = selectedQuestions[currentIndex];
  let lecture1, lecture2, alt1;
  let photoHTML = '';

  if(q.theme === "Calculer l'altitude du point 1"){
    const lectureRef = Math.floor(Math.random()*(4000-100+1))+100;
    let lecturePt1; do { lecturePt1=Math.floor(Math.random()*(4000-100+1))+100; } while(lecturePt1===lectureRef);
    const altRef = Math.floor(Math.random()*(1000-100+1))+100;
    lecture1=lectureRef; lecture2=lecturePt1; alt1=altRef;
    photoHTML=`<img src="https://raw.githubusercontent.com/CETPC-Christophe/-Le-nivellement-direct/refs/heads/main/Niv%20direct%201.png" alt="Illustration" style="max-width:60%; margin-bottom:15px; border-radius:6px;">`;

  } else if(q.theme === "Calculer l'altitude du point 2"){
    const lecturePt1 = Math.floor(Math.random()*(4000-100+1))+100;
    let lecturePt2; do { lecturePt2=Math.floor(Math.random()*(4000-100+1))+100; } while(lecturePt2===lecturePt1);
    const altPt1 = Math.floor(Math.random()*(1000-100+1))+100;
    lecture1=lecturePt1; lecture2=lecturePt2; alt1=altPt1;
    photoHTML=`<img src="https://raw.githubusercontent.com/CETPC-Christophe/-Le-nivellement-direct/refs/heads/main/Niv%20direct%202.png" alt="Illustration" style="max-width:60%; margin-bottom:15px; border-radius:6px;">`;
  }

  q.lecture1 = lecture1; q.lecture2 = lecture2; q.alt1 = alt1;

  DOM.quiz.innerHTML = `
    <div class="question">
      <p>üìÇ ${q.theme}</p>
      <p>${i18n.question.replace("{num}",currentIndex+1).replace("{total}",selectedQuestions.length).replace("{text}",q.text)}</p>
      ${photoHTML}
      <div class="answers">
        <p>${q.theme==="Calculer l'altitude du point 1"?"Lecture point de r√©f√©rence":"Lecture point 1"} : <strong>${lecture1} mm</strong></p>
        <p>${q.theme==="Calculer l'altitude du point 1"?"Lecture point 1":"Lecture point 2"} : <strong>${lecture2} mm</strong></p>
        <p>${q.theme==="Calculer l'altitude du point 1"?"Altitude du point de r√©f√©rence":"Altitude du point 1"} : <strong>${alt1} m</strong></p>
        <input type="number" step="0.001" id="answerField" placeholder="Altitude √† calculer (m)">
      </div>
      <button id="nextBtn" disabled>${currentIndex===selectedQuestions.length-1 ? i18n.finishBtn : i18n.nextBtn}</button>
    </div>
  `;

  const answerField=document.getElementById("answerField");
  const nextBtn=document.getElementById("nextBtn");
  answerField.addEventListener("input",()=>{ nextBtn.disabled=answerField.value.trim()===""; });

  nextBtn.onclick=()=>{
    const userVal=Number(answerField.value.trim());
    const correctVal=Number((alt1 + (lecture1-lecture2)/1000).toFixed(3));
    q.correct=correctVal;
    userAnswers[currentIndex]=userVal;
    currentIndex++;
    if(currentIndex<selectedQuestions.length) renderQuestion();
    else showResults();
  };
}

function downloadCSV() {
  const totalPoints=selectedQuestions.length * 2;
  let csv="Question;Lecture1 (mm);Lecture2 (mm);Altitude1 (m);R√©ponse √©l√®ve;R√©ponse correcte;Points max\n";
  selectedQuestions.forEach((q,i)=>{
    csv+=`${i+1};${q.lecture1};${q.lecture2};${q.alt1};${userAnswers[i].toFixed(3)};${q.correct.toFixed(3)};2\n`;
  });
  csv+=`;;;;;Note obtenue;${score}\n`;
  csv+=`;;;;;Maximum possible;${totalPoints}\n`;

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`resultat_${candidateName}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function sendResultToSheet(){
  const totalPoints=selectedQuestions.length * 2;
  const data={
    name:candidateName,
    score:score,
    maxPoints:totalPoints,
    quizName:quizName
  };

  const loadingDiv=document.getElementById("sendingStatus");
  if(loadingDiv){
    loadingDiv.style.display="block";
    loadingDiv.innerHTML='<p style="color:#ff6600; font-weight:bold;">‚è≥ Envoi des r√©sultats en cours...</p>';
  }

  const downloadBtn=document.getElementById("downloadBtn");
  if(downloadBtn) downloadBtn.style.display="none";

  fetch("https://script.google.com/macros/s/AKfycby_oKkLewevY4YVSTpQQZZbmk70C6aYliWt_mnDn7H1aK1gRc0M4wpmUMZc9voBebut/exec",{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(data)
  }).then(res=>res.json()).then(res=>{
    if(res.status==="success"){
      if(loadingDiv){
        loadingDiv.innerHTML='<p style="color:#388e3c; font-weight:bold;">‚úÖ R√©sultats enregistr√©s avec succ√®s !</p>';
      }
      if(downloadBtn) downloadBtn.style.display="inline-block";
    } else {
      if(loadingDiv){
        loadingDiv.innerHTML='<p style="color:#d32f2f; font-weight:bold;">‚ùå Erreur lors de l\'envoi</p>';
      }
      if(downloadBtn) downloadBtn.style.display="inline-block";
    }
  }).catch(err=>{
    console.error("Erreur d'envoi :",err);
    if(loadingDiv){
      loadingDiv.innerHTML='<p style="color:#d32f2f; font-weight:bold;">‚ùå Erreur de connexion</p>';
    }
    if(downloadBtn) downloadBtn.style.display="inline-block";
  });
}

function showResults(){
  const totalPoints=selectedQuestions.length * 2;
  score=0;
  selectedQuestions.forEach((q,i)=>{ if(userAnswers[i]===q.correct) score+=2; });

  const percentage=Math.round((score/totalPoints)*100);
  let scoreColor="#d32f2f";
  if(percentage>=80) scoreColor="#388e3c";
  else if(percentage>=50) scoreColor="#f57c00";

  let tableHTML=`<table>
  <thead><tr>
  <th>Question</th><th>Lecture1 (mm)</th><th>Lecture2 (mm)</th><th>Altitude1 (m)</th><th>R√©ponse √©l√®ve</th><th>R√©ponse correcte</th><th>Points max</th>
  </tr></thead><tbody>`;

  selectedQuestions.forEach((q,i)=>{
    const isError = userAnswers[i].toFixed(3) !== q.correct.toFixed(3);
    const answerStyle = isError ? 'style="background-color:#ffcccc;"' : '';
    tableHTML+=`<tr>
    <td>${i+1}</td><td>${q.lecture1}</td><td>${q.lecture2}</td><td>${q.alt1}</td><td ${answerStyle}>${userAnswers[i].toFixed(3)}</td><td>${q.correct.toFixed(3)}</td><td>2</td>
    </tr>`;
  });
  tableHTML+=`</tbody></table>`;

  DOM.quiz.innerHTML=`<div class="question">
  <p>${i18n.candidate} <strong>${candidateName}</strong></p>
  <p>${i18n.result} <strong style="color:${scoreColor}">${score} / ${totalPoints} points (${percentage}%)</strong></p>
  ${tableHTML}
  <div id="sendingStatus" style="display:none; margin-top:15px;"></div>
  </div>`;

  sendResultToSheet();
  DOM.restartBtn.style.display="inline-block";
}

function showIntro(){
  DOM.intro.style.display="flex";
  DOM.quiz.style.display="none";
  DOM.restartBtn.style.display="none";
  DOM.quizSubtitle.textContent="";
  DOM.pageTitle.textContent="Le nivellement direct";
  DOM.testTypeSelection.style.display="block";
  DOM.nameSelection.style.display="none";
  DOM.candidateName.value="";
  DOM.startBtn.disabled=true;
  testType = "";
  questionCount = 10;
}

function selectTestType(type, count){
  testType = type;
  questionCount = count;
  DOM.pageTitle.textContent = type.toUpperCase();
  DOM.testTypeSelection.style.display="none";
  DOM.nameSelection.style.display="block";
  DOM.candidateName.focus();
  DOM.candidateName.oninput=()=>{ DOM.startBtn.disabled=DOM.candidateName.value.trim().length<2; };
}

function startQuiz(){
  candidateName=DOM.candidateName.value.trim().toUpperCase();
  if(!candidateName) return;
  const isAuthorized=Object.values(AUTHORIZED_CANDIDATES).some(group=>group.includes(candidateName));
  if(!isAuthorized){ alert("‚ùå Acc√®s refus√©. Votre nom n'est pas autoris√© pour faire ce test."); DOM.candidateName.value=""; DOM.startBtn.disabled=true; return; }
  DOM.intro.style.display="none";
  DOM.quiz.style.display="block";
  quizName="MODULE 4 - " + testType;
  selectedQuestions=getRandomQuestionsIntercalated();
  currentIndex=0;
  userAnswers=new Array(selectedQuestions.length).fill(0);
  renderQuestion();
}

document.addEventListener("DOMContentLoaded",()=>{
  showIntro();
  DOM.startBtn.onclick=startQuiz;
  DOM.restartBtn.onclick=showIntro;
  DOM.trainingBtn.onclick=()=>selectTestType("Entra√Ænement", 10);
  DOM.evaluationBtn.onclick=()=>selectTestType("√âvaluation", 10);
});
</script>
</body>
</html>
