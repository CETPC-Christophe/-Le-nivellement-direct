<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bilan formation Conduite en s√©curit√©</title>
<style>
:root { --orange:#ff6600; --noir:#222; --gris:#f3f3f3; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--gris); color: var(--noir); margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:16px; }
.banner { background:var(--noir); color:#fff; padding:10px; border-radius:10px; text-align:center; font-weight:700; width:100%; max-width:820px; margin-bottom:15px; }
h1 { color:var(--orange); text-align:center; margin:8px 0; }
.subtitle { color:#555; text-align:center; margin-bottom:18px; }
.question { background:#fff; padding:20px; margin:10px auto; border-left:8px solid var(--orange); border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.08); width:100%; max-width:820px; text-align:center; }
.question p { font-weight:600; }
.answers input[type="number"] { width:90%; max-width:420px; padding:10px; font-size:1.1rem; border-radius:6px; border:1px solid #ccc; margin-top:10px; }
button { background:var(--orange); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-size:1rem; cursor:pointer; margin-top:15px; }
button[disabled] { opacity:0.5; cursor:not-allowed; }
button:hover:not([disabled]) { background:#e65c00; }
@media (max-width:600px){ .answers input{ width:100%; } }
</style>
</head>
<body>

<div class="banner">üìö Bilan formation Conduite en s√©curit√© üìö</div>
<h1>√âVALUATION</h1>
<p class="subtitle" id="quizSubtitle"></p>

<div id="intro" class="intro">
  <div class="question">
    <p id="welcomeTitle"></p>
    <p id="welcomeText"></p>
    <input id="candidateName" type="text" placeholder="Nom de l'√©l√®ve">
    <div style="margin-top:12px;">
      <button id="startBtn" disabled>‚û°Ô∏è Suivant</button>
    </div>
  </div>
</div>

<div id="quiz" style="display:none; width:100%; max-width:820px;"></div>
<div class="control-container" style="text-align:center;">
  <button id="restartBtn" style="display:none;">üîÑ Nouvelle √©valuation</button>
</div>

<p id="result"></p>

<script>
const i18n = {
  welcome: "Bienvenue",
  enterName: "Merci d'indiquer votre nom avant de commencer :",
  studentName: "Nom de l'√©l√®ve",
  nextBtn: "‚û°Ô∏è Suivant",
  finishBtn: "üèÅ Terminer",
  questions: "R√©pondez √† {count} questions",
  candidate: "Candidat : ",
  date: "Date : ",
  result: "R√©sultat : ",
  question: "‚öôÔ∏è Question {num} / {total} : {text}"
};

const AUTHORIZED_CANDIDATES = {
  "Professeur": ["MARINO","CHARDON","CHIOTTI","MATHIEU","MAUSSION"],
  "1 cetpc": ["BONTEMPS","BRIATORE","BUCCIO","DIONISI","ERETEO","GARNERO","GRISONI","GUENEAU","HADANGUE","LACROIX","LEJEUNE","MAAZAOUI","MARTINEAU","MONELLO","PI-BUTHION","QUILICO","REMY","SANTIAGO","SCIARAFFA","THEVENET","TRUFFE","VILLEROY"],
  "2 cetpc": ["ALBERT","AUDISIO","BABA","BERTOLOTTO","BOUCHEE","BOUFFART","BOURGUIGNON","BOUSQUET","CAPPADORO","COLPAERT","CULMINE","DOYEN","GAALOUL","GEORGE","GUEURUNURIAN","MONTEIRO","PAGE","PALAGONIA","PELLET","PONZO","PRUVOST","RICHARD","TETI"]
};

const allThemes = [
  { name:"Calculer l'altitude du point 1", count:5, questions:[ { text:"Calculez l'altitude du point 1." } ] }
];

let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = "";

const DOM = {
  intro: document.getElementById("intro"),
  quiz: document.getElementById("quiz"),
  startBtn: document.getElementById("startBtn"),
  restartBtn: document.getElementById("restartBtn"),
  candidateName: document.getElementById("candidateName"),
  result: document.getElementById("result"),
  quizSubtitle: document.getElementById("quizSubtitle"),
  welcomeTitle: document.getElementById("welcomeTitle"),
  welcomeText: document.getElementById("welcomeText")
};

function shuffle(arr){ return arr.sort(()=>Math.random()-0.5); }
function getRandomQuestions(){
  let finalList = [];
  for(const theme of allThemes){
    const chosen = shuffle([...theme.questions]).slice(0, theme.count);
    chosen.forEach(q=>q.theme=theme.name);
    finalList.push(...chosen);
  }
  return finalList;
}

function renderQuestion(){
  const q = selectedQuestions[currentIndex];

  // G√©n√©ration al√©atoire des valeurs
  const lectureRef = Math.floor(Math.random()*(4000-100+1))+100;
  let lecturePt1;
  do{ lecturePt1=Math.floor(Math.random()*(4000-100+1))+100; } while(lecturePt1===lectureRef);
  const altRef = Math.floor(Math.random()*(1000-100+1))+100;

  q.lectureRef = lectureRef;
  q.lecturePt1 = lecturePt1;
  q.altRef = altRef;

  DOM.quiz.innerHTML=`
    <div class="question">
      <p>üìÇ ${q.theme}</p>
      <p>${i18n.question.replace("{num}",currentIndex+1).replace("{total}",selectedQuestions.length).replace("{text}",q.text)}</p>
      <div class="answers">
        <p>Lecture point de r√©f√©rence : <strong>${lectureRef} mm</strong></p>
        <p>Lecture point 1 : <strong>${lecturePt1} mm</strong></p>
        <p>Altitude du point de r√©f√©rence : <strong>${altRef} m</strong></p>
        <input type="number" step="0.001" id="answerField" placeholder="Altitude du point 1 (m)">
      </div>
      <button id="nextBtn" disabled>${currentIndex===selectedQuestions.length-1 ? i18n.finishBtn : i18n.nextBtn}</button>
    </div>
  `;

  const answerField=document.getElementById("answerField");
  const nextBtn=document.getElementById("nextBtn");

  answerField.addEventListener("input",()=>{ nextBtn.disabled=answerField.value.trim()===""; });

  nextBtn.onclick=()=>{
    const userVal=Number(answerField.value.trim());
    const correctVal=Number((altRef + (lectureRef - lecturePt1)).toFixed(3));
    q.correct=correctVal;
    userAnswers[currentIndex]=userVal;
    currentIndex++;
    if(currentIndex<selectedQuestions.length) renderQuestion();
    else showResults();
  };
}

function showResults(){
  const totalPoints=selectedQuestions.length;
  let score=0;
  selectedQuestions.forEach((q,i)=>{ if(userAnswers[i]===q.correct) score++; });

  const percentage=Math.round((score/totalPoints)*100);
  let scoreColor="#d32f2f";
  if(percentage>=80) scoreColor="#388e3c";
  else if(percentage>=50) scoreColor="#f57c00";

  const now=new Date();
  const dateStr=now.toLocaleDateString("fr-FR");
  const timeStr=now.toLocaleTimeString("fr-FR");

  DOM.quiz.innerHTML=`
    <div class="question">
      <p>${i18n.candidate} <strong>${candidateName}</strong></p>
      <p>${i18n.result} <strong style="color:${scoreColor}">${score} / ${totalPoints} points (${percentage}%)</strong></p>
      <p>${i18n.date} <strong>${dateStr} ${timeStr}</strong></p>
    </div>
  `;
  DOM.restartBtn.style.display="inline-block";
}

function showIntro(){
  DOM.intro.style.display="flex";
  DOM.quiz.style.display="none";
  DOM.restartBtn.style.display="none";
  DOM.quizSubtitle.textContent="";
  DOM.welcomeTitle.textContent=i18n.welcome;
  DOM.welcomeText.textContent=i18n.enterName;
  DOM.candidateName.value="";
  DOM.startBtn.disabled=true;
  DOM.candidateName.focus();
  DOM.candidateName.oninput=()=>{ DOM.startBtn.disabled=DOM.candidateName.value.trim().length<2; };
}

function startQuiz(){
  candidateName=DOM.candidateName.value.trim().toUpperCase();
  if(!candidateName) return;
  const isAuthorized=Object.values(AUTHORIZED_CANDIDATES).some(group=>group.includes(candidateName));
  if(!isAuthorized){ alert("‚ùå Acc√®s refus√©. Votre nom n'est pas autoris√© pour faire ce test."); DOM.candidateName.value=""; DOM.startBtn.disabled=true; return; }
  DOM.intro.style.display="none";
  DOM.quiz.style.display="block";
  selectedQuestions=getRandomQuestions();
  currentIndex=0;
  userAnswers=new Array(selectedQuestions.length).fill(0);
  DOM.quizSubtitle.textContent=i18n.questions.replace("{count}",selectedQuestions.length);
  renderQuestion();
}

document.addEventListener("DOMContentLoaded",()=>{
  showIntro();
  DOM.startBtn.onclick=startQuiz;
  DOM.restartBtn.onclick=showIntro;
});
</script>
</body>
</html>
